<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLite数据库查看器</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>SQLite 数据库查看器</h1>
            <p>上传并查看 .db 文件中的表格数据</p>
        </header>

        <!-- <div class="file-section">
            <h2>1. 选择数据库文件</h2>
            <input type="file" id="dbFile" class="file-input" accept=".db,.sqlite,.sqlite3">
            <div id="fileStatus" class="status"></div>
        </div> -->

        <div class="file-section">
            <h2>1. 数据库文件</h2>
            <div id="fileInfo" class="file-info">
                <strong>文件路径：</strong>
                <span id="filePath" style="color: blue;"></span>
            </div>
            <div id="fileStatus" class="status"></div>
        </div>
        <!-- ########### -->
        <!-- <div>
            <strong>从WPF获取的文件路径：</strong>
            <span id="filePath" style="color: blue;"></span>
        </div> -->


        <div class="customization-panel">
            <h2 style="width: 100%; margin-top: 0;">2. 自定义样式</h2>
            <div class="customization-group">
                <label for="fontFamily">字体</label>
                <select id="fontFamily">
                    <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">默认字体</option>
                    <option value="Arial, Helvetica, sans-serif">Arial</option>
                    <option value="'Times New Roman', Times, serif">Times New Roman</option>
                    <option value="'Courier New', Courier, monospace">Courier New</option>
                    <option value="Georgia, serif">Georgia</option>
                </select>
            </div>

            <div class="customization-group">
                <label for="fontSize">字体大小</label>
                <select id="fontSize">
                    <option value="12px">12px</option>
                    <option value="14px" selected>14px</option>
                    <option value="16px">16px</option>
                    <option value="18px">18px</option>
                </select>
            </div>

            <div class="customization-group">
                <label for="backgroundColor">背景颜色</label>
                <input type="color" id="backgroundColor" value="#f5f7fa">
            </div>

            <div class="customization-group">
                <label for="tableHeaderBg">表头背景</label>
                <input type="color" id="tableHeaderBg" value="#e9ecef">
            </div>

            <div class="customization-group">
                <label for="tableBorderColor">边框颜色</label>
                <input type="color" id="tableBorderColor" value="#dee2e6">
            </div>
        </div>

        <div class="tables-section">
            <h2>3. 选择表格</h2>
            <div id="tableList" class="table-list">
                <!-- 表格按钮将在这里动态生成 -->
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>正在加载数据...</p>
            </div>

            <div id="tableContainer" class="table-container">
                <!-- 表格将在这里显示 -->
            </div>
        </div>

        <footer>
            <p>使用 sql.js 解析 SQLite 数据库文件 | 数据库查看器 v1.0</p>
        </footer>
    </div>

    <script src="script.js"></script>
    <script>
    // 从 Base64 加载数据库的函数
    function loadDatabaseFromBase64(base64Data) {
        console.log('开始从Base64加载数据库...');
        const status = document.getElementById('fileStatus');
        status.textContent = '正在加载数据库...';
        status.className = 'status';
        status.style.display = 'block';
        
        document.getElementById('loading').style.display = 'block';
        
        try {
            console.log('Base64数据长度:', base64Data.length);
            
            // 解码 Base64
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            
            console.log('Base64解码成功，数据大小:', bytes.length, 'bytes');
            
            return initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            }).then(SQL => {
                console.log('SQL.js 加载成功');
                
                try {
                    // 加载数据库
                    db = new SQL.Database(bytes);
                    console.log('数据库加载成功');
                    
                    // 显示表格列表
                    displayTableList();
                    
                    status.textContent = '成功加载数据库';
                    status.className = 'status success';
                    document.getElementById('loading').style.display = 'none';
                    
                } catch (dbError) {
                    console.error('数据库操作错误:', dbError);
                    status.textContent = '数据库操作失败: ' + dbError.message;
                    status.className = 'status error';
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
        } catch (error) {
            console.error('Base64处理错误:', error);
            status.textContent = '数据处理失败: ' + error.message;
            status.className = 'status error';
            document.getElementById('loading').style.display = 'none';
        }
    }

    // 页面加载完成后检查是否有预加载的数据
    window.onload = function () {
        console.log('页面加载完成');
        
        // 如果 WPF 已经注入了数据库数据，就使用它
        if (window.databaseBase64) {
            console.log('发现预加载的数据库数据，开始加载...');
            loadDatabaseFromBase64(window.databaseBase64);
        } else {
            console.log('没有预加载的数据库数据');
            // 如果没有预加载数据，可以显示提示信息
            document.getElementById('fileStatus').textContent = '未加载数据库文件';
            document.getElementById('fileStatus').className = 'status';
        }
    };
</script>
</body>

</html>